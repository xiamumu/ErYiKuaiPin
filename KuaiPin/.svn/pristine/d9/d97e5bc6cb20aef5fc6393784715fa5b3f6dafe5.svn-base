//
//  AppDelegate.m
//  KuaiPin
//
//  Created by 21_xm on 16/4/25.
//  Copyright Â© 2016å¹´ 21_xm. All rights reserved.
//

#import "AppDelegate.h"
#import "KPRootVcTool.h"
#import "KPAppCatchExceptionHandler.h"

#import "KPNavigationController.h"
#import "KPLoginRegisterViewController.h"
#import "KPNewPayPwdViewController.h"
#import "KPCommitAuthCodeViewController.h"

#import <JPFPSStatus.h>
#import "JPUSHService.h"
#import "RealReachability.h"
#import "KPNetworkingStatusView.h"
#import "AFNetworkReachabilityManager.h"
#import "KPPayManager.h"
#import "KPSharedTool.h"


#define JPUSHAppKey @"b5402a3c6d3207bd65c226ee"

@interface AppDelegate ()

@end

@implementation AppDelegate

#pragma mark - ç³»ç»Ÿæ–¹æ³•
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {

    self.window = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
    self.window.backgroundColor = [UIColor whiteColor];
    [KPRootVcTool rootVcWithKeyWindow:self.window];
    
//    WHYNSLog(@"%@", [NSBundle mainBundle]);

    /** æŸ¥çœ‹æ‰‹æœºåˆ·æ–°é¢‘ç‡ */
#if defined(DEBUG)||defined(_DEBUG)
    [[JPFPSStatus sharedInstance] open];
#endif
    
    // æ·»åŠ æå…‰æ¨é€
    [self setupJPushWithOptions:launchOptions];
    
//    å¼€å§‹ç›‘å¬ç½‘ç»œçŠ¶æ€
    [self startNetworkMonitoring];

//    æ³¨å†Œå¾®ä¿¡API
    [WXApi registerApp:WXAPPID];

//    å‹ç›Ÿç»Ÿè®¡
    [KPStatisticsTool registUMAnalyticsConfig];
//    [KPStatisticsTool lookupDeviceId];
    
    // å‹ç›Ÿåˆ†äº«
    [KPSharedTool registSharedTool];

    [self.window makeKeyAndVisible];
    return YES;
}

- (void)applicationWillResignActive:(UIApplication *)application {
    
}

- (void)applicationDidEnterBackground:(UIApplication *)application {

    WHYNSLog(@"æ³¨é”€é€šçŸ¥");
    
}

- (void)applicationWillEnterForeground:(UIApplication *)application {
    
    
    
}

- (void)applicationDidBecomeActive:(UIApplication *)application {
    application.applicationIconBadgeNumber -= 1;
    
    [self setupNotification];
}

- (void)applicationWillTerminate:(UIApplication *)application {
    // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.
}

- (BOOL)application:(UIApplication *)application openURL:(NSURL *)url sourceApplication:(NSString *)sourceApplication annotation:(id)annotation {

    BOOL sharedRes = [KPSharedTool handleOpenURL:url];

    if (sharedRes == NO) {
//    æ”¯ä»˜å›è°ƒ
        return [KPPayManager handleOpenURL:url];
    }

    return sharedRes;
}

#pragma mark - æ·»åŠ æå…‰æ¨é€
- (void)setupJPushWithOptions:(NSDictionary *)launchOptions
{
    
    [JPUSHService registerForRemoteNotificationTypes:(UIUserNotificationTypeBadge |
                                                      UIUserNotificationTypeSound |
                                                      UIUserNotificationTypeAlert)
                                          categories:nil];
    //Required
    // å¦‚éœ€ç»§ç»­ä½¿ç”¨pushConfig.plistæ–‡ä»¶å£°æ˜appKeyç­‰é…ç½®å†…å®¹ï¼Œè¯·ä¾æ—§ä½¿ç”¨[JPUSHService setupWithOption:launchOptions]æ–¹å¼åˆå§‹åŒ–ã€‚
    [JPUSHService setupWithOption:launchOptions
                           appKey:JPUSHAppKey
                          channel:@"App Store"
                 apsForProduction:NO
            advertisingIdentifier:nil];
}

- (void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken
{
    /// Required - æ³¨å†Œ DeviceToken
    [JPUSHService registerDeviceToken:deviceToken];
}

- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo
{
    [JPUSHService handleRemoteNotification:userInfo];
}

- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
{
    NSString *alert = userInfo[@"aps"][@"alert"];
    WHYNSLog(@"-------notiAlert--------%@", alert);
    [JPUSHService handleRemoteNotification:userInfo];
    completionHandler(UIBackgroundFetchResultNewData);
}

- (void)application:(UIApplication *)application didFailToRegisterForRemoteNotificationsWithError:(NSError *)error
{
    //Optional
    WHYNSLog(@"did Fail To Register For Remote Notifications With Error: %@", error);
}

#pragma mark - å†…å­˜å‘Šæ€¥æ—¶å¤„ç†
- (void)applicationDidReceiveMemoryWarning:(UIApplication *)application
{
    // æ¸…é™¤æ‰€æœ‰çš„å†…å­˜ç¼“å­˜
    [[SDImageCache sharedImageCache] clearMemory];
    
    // åœæ­¢æ­£åœ¨è¿›è¡Œçš„å›¾ç‰‡ä¸‹è½½æ“ä½œ
    [[SDWebImageManager sharedManager] cancelAll];
}

#pragma mark - ç§æœ‰æ–¹æ³•
- (void)setupNotification {
    
    WHYNSLog(@"æ³¨å†Œé€šçŸ¥");

}

- (void)startNetworkMonitoring {
    AFNetworkReachabilityManager * reachabilityManager = [AFNetworkReachabilityManager sharedManager];
    [reachabilityManager setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) {
        switch (status) {
            case AFNetworkReachabilityStatusUnknown:
            case AFNetworkReachabilityStatusNotReachable: {
                [KPNetworkingStatusView showNoNetworkingStatus];
                break;
            }
            case AFNetworkReachabilityStatusReachableViaWWAN:
            case AFNetworkReachabilityStatusReachableViaWiFi: {
                [KPNetworkingStatusView hideNoNetworkingStatus];
                break;
            }
        }
    }];
    [reachabilityManager startMonitoring];
}

@end
